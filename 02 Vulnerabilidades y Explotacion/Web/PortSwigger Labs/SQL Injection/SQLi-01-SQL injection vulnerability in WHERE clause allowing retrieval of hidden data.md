# SQL injection vulnerability in WHERE clause allowing retrieval of hidden data

**Categor√≠a:** SQLi

**Dificultad:** Apprentice

**Fuente:** PortSwigger Web Security Academy

---

# üéØ Resumen

* **Objetivo del lab**: Explorar c√≥mo una inyecci√≥n SQL en una cl√°usula `WHERE` permite acceder a productos ocultos.
* **Vulnerabilidad principal**: SQL Injection (en el par√°metro `category`).
* **Impacto esperado**: Exposici√≥n de datos no liberados (productos unreleased).

---

# üß≠ Reconocimiento

* **Mapa de la aplicaci√≥n**: `/filter?category=<valor>` lista productos seg√∫n categor√≠a.
* **Par√°metro relevante**: `category`.
* **Consulta SQL sospechada**:

  ```sql
  SELECT * FROM products WHERE category = '<USER_INPUT>' AND released = 1
  ```
* **Hip√≥tesis**: Si el valor no est√° correctamente escapado, se puede alterar la l√≥gica de la consulta.

---

# üõ†Ô∏è Explotaci√≥n paso a paso

## Paso 1 ‚Äì Identificar el punto vulnerable

* **Qu√© hago**: Probar con `'` al final de la categor√≠a.
* **Por qu√© funciona**: Una comilla sin escapar rompe la consulta.
* **Evidencia**: El servidor devuelve error 500 (indicio de inyecci√≥n SQL).

## Paso 2 ‚Äì Alterar la l√≥gica del `WHERE`

* **Qu√© hago**: Inyecto un OR siempre verdadero:

  ```http
  GET /filter?category=Gifts' or 1=1-- -
  ```
* **Por qu√© funciona**: `1=1` hace que la condici√≥n se cumpla para todos los registros, incluyendo los productos unreleased.
* **Evidencia**: La p√°gina muestra m√°s productos, incluyendo los que antes no aparec√≠an.

---

# ‚úÖ PoC m√≠nima

```http
GET /filter?category=Gifts' or 1=1-- -
Host: <lab-id>.web-security-academy.net
```

Con esta petici√≥n, todos los productos se listan, incluyendo los ocultos.

---

# üîí Defensa

* **Causas**: Concatenaci√≥n directa de entrada del usuario en la consulta SQL.
* **Detecci√≥n en logs**:

  * Par√°metros con `' or 1=1-- -`
  * Errores frecuentes de SQL en logs
* **Mitigaci√≥n recomendada**:

  * Usar *prepared statements* / consultas parametrizadas
  * Validar y sanear entradas
  * Principio de *least privilege* en la base de datos (usuario de lectura restringido)

---

# üìù Notas y trampas

* Algunos labs no aceptan comentarios SQL de un solo `-`, aqu√≠ se usa `-- -` (espacio extra tras `--`).
* El par√°metro vulnerable puede estar en GET o POST, siempre conviene probar ambos.

---

# üìö Referencias

* [PortSwigger Lab ‚Äì SQL injection vulnerability in WHERE clause allowing retrieval of hidden data](https://portswigger.net/web-security/sql-injection/lab-retrieve-hidden-data)
* [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
